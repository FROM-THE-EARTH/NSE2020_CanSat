# サーバー機能について

## 概要

サーバー機能は文字通り機体にサーバーとしての振る舞いをさせるための機能です．
サーバー機能に関するコードは [can09/server/](../../can09/server/) にあります．

そもそもサーバーとは，コンピュータネットワークモデルの1つである[クライアントサーバーモデル](https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%B5%E3%83%BC%E3%83%90%E3%83%A2%E3%83%87%E3%83%AB)におけるサーバーのことです．
クライアントサーバーモデルにはクライアントとサーバーという2つの登場人物が出てきて，クライアントがサーバーに何らかの処理を**リクエスト**し，サーバーがそのリクエストに対して**レスポンス**を返すという方式をとります．
つまり，クライアントとサーバーには明確な主従関係があることになります．

今回のミッションでクライアントサーバーモデルを採用する理由は，親機は基本的にアクティブであるのに対し，子機はアクチュエータを持たず，ミッション中の単体の役割が曖昧である点にあります．
そこで，**子機をサーバー化**してしまい，親機をクライアントとすることで，子機のミッション中における役割を明確化することにしました．

本ミッションではクライアントは親機および管制局なので，クライアントサーバーモデルを採用する大きな恩恵は受けられませんが，このモデルは複数の機体をいっぺんに走査させる場合には大きな価値を持ちます．
つまり，クライアントが惑星探査を行いながら，データの整合性やミッションの進捗などをサーバーが管理するわけです．
残念ながら今回のミッションではそのような大規模なことは行えませんが，今後の開発の指針となるような試みであるとは言えるでしょう．

## フォーマット

クライアントがサーバーにリクエストを送るにも，サーバーがクライアントにレスポンスを送るにも，どちらもある決まったデータのフォーマットを必要とします．
もし所定のフォーマットでデータが送られてこなければ，コンピュータはデータを認識することが困難になるためです．

フォーマットは[こちら](./format.md)で定義されています．
フォーマットの詳細を把握する必要はありませんが，通信関連の処理を行う場合にはざっくりと把握しておくと良いでしょう．

## コマンド

リクエストの中身は主に**コマンド**とその**引数**で出来ています．
これは，ターミナルで打つコマンドの内容を通信でやり取りしているというイメージです．

コマンドは [CommandBase](../../can09/server/command_base.py) を継承するクラスで表現されます．
コマンドクラスの詳細については[こちら](./command.md)を参照してください．

## サーバーとクライアント

フォーマットやコマンドはただの情報を表す概念に過ぎません．
実際にフォーマットやコマンドを使って通信を行うのはサーバーとクライアントです．

サーバーは [CommandServer](../../can09/server/command_server.py) を利用します．
このクラスはサーバーを起動するとクライアントからのリクエストを受け付け，リクエストが来るとその内容 (主にコマンドと引数) を解析し，その内容に基づいて処理を行い，必要があればクライアントにレスポンスを返します．

クライアントにはクライアント用の特別なクラスは用意されていませんが，pisat.comm.transceiver.CommSocket を利用すると便利です．
このクラスは自分のアドレスと相手のアドレスをつなぎ，まるでその間だけの通信であるかのように偽装します．
つまりクライアントは CommSocket をサーバーのアドレスを指定して生成することで，サーバーとのコネクションを獲得するわけです．

サーバーとクライアントの詳細については[こちら](./server_client.md)を参照してください．
